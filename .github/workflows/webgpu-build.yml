name: WebGPU Build Test

on:
  push:
    branches: [ main, modulize, copilot/switch-to-webgpu-backend ]
  pull_request:
    branches: [ main, modulize ]

jobs:
  # Test WebGPU infrastructure generation (fast check)
  webgpu-generation:
    name: WebGPU Generation Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
    
    - name: Configure CMake (WebGPU Generation)
      run: |
        cmake -B build -G Ninja \
          -DEPX_USE_WEBGPU=ON \
          -DEPX_WGPU_USE_MODULE=OFF \
          -DGLFW_BUILD_WAYLAND=OFF \
          -DEPX_BUILD_EXAMPLES=OFF \
          -DEPIX_CXX_MODULE=OFF
    
    - name: Verify Generated Files
      run: |
        echo "Checking generated WebGPU files..."
        ls -lh build/generated/webgpu/
        test -f build/generated/webgpu/webgpu.hpp || exit 1
        test -f build/generated/webgpu/webgpu-raii.hpp || exit 1
        test -f build/generated/webgpu/webgpu.cppm || exit 1
        echo "✓ All WebGPU files generated successfully"
    
    - name: Build WebGPU Test
      run: |
        cmake --build build --target test_webgpu_header
    
    - name: Run Test
      run: |
        cd build
        ctest --output-on-failure -R test_webgpu_header

  # Windows build with MSVC (full module support)
  windows-msvc:
    name: Windows MSVC Build
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DEPX_USE_WEBGPU=ON `
          -DEPX_WGPU_USE_MODULE=ON `
          -DEPX_BUILD_EXAMPLES=OFF `
          -DEPIX_CXX_MODULE=OFF
    
    - name: Verify Generated Files
      run: |
        Write-Host "Checking generated WebGPU files..."
        Get-ChildItem -Path build/generated/webgpu/
        Test-Path build/generated/webgpu/webgpu.hpp
        Test-Path build/generated/webgpu/webgpu-raii.hpp
        Test-Path build/generated/webgpu/webgpu.cppm
        Write-Host "✓ All WebGPU files generated successfully"
    
    - name: Build WebGPU Test
      run: |
        cmake --build build --config Release --target test_webgpu_header
    
    - name: Run Test
      run: |
        cd build
        ctest -C Release --output-on-failure -R test_webgpu_header

  # macOS build
  macos:
    name: macOS Build
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Dependencies
      run: |
        brew install ninja
    
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DEPX_USE_WEBGPU=ON \
          -DEPX_WGPU_USE_MODULE=OFF \
          -DEPX_BUILD_EXAMPLES=OFF \
          -DEPIX_CXX_MODULE=OFF
    
    - name: Verify Generated Files
      run: |
        echo "Checking generated WebGPU files..."
        ls -lh build/generated/webgpu/
        test -f build/generated/webgpu/webgpu.hpp || exit 1
        test -f build/generated/webgpu/webgpu-raii.hpp || exit 1
        test -f build/generated/webgpu/webgpu.cppm || exit 1
        echo "✓ All WebGPU files generated successfully"
    
    - name: Build WebGPU Test
      run: |
        cmake --build build --target test_webgpu_header
    
    - name: Run Test
      run: |
        cd build
        ctest --output-on-failure -R test_webgpu_header
